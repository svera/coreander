import{AnnotationEditorType as e,AnnotationEditorUIManager as t,AnnotationMode as i,PermissionFlag as s,PixelsPerInch as n,PromiseCapability as r,version as o}from"pdfjs-lib";import{DEFAULT_SCALE as a,DEFAULT_SCALE_DELTA as l,DEFAULT_SCALE_VALUE as h,docStyle as c,getVisibleElements as d,isPortraitOrientation as u,isValidRotation as g,isValidScrollMode as p,isValidSpreadMode as f,MAX_AUTO_SCALE as _,MAX_SCALE as m,MIN_SCALE as P,PresentationModeState as b,removeNullCharacters as v,RenderingStates as C,SCROLLBAR_PADDING as E,scrollIntoView as S,ScrollMode as w,SpreadMode as M,TextLayerMode as N,UNKNOWN_SCALE as y,VERTICAL_PADDING as D,watchScroll as I}from"./ui_utils.js";import{NullL10n as A}from"./l10n_utils.js";import{PDFPageView as L}from"./pdf_page_view.js";import{PDFRenderingQueue as O}from"./pdf_rendering_queue.js";import{SimpleLinkService as V}from"./pdf_link_service.js";const R={FORCE_SCROLL_MODE_PAGE:15e3,FORCE_LAZY_PAGE_INIT:7500,PAUSE_EAGER_PAGE_INIT:250};function F(t){return Object.values(e).includes(t)&&t!==e.DISABLE}class T{#e=new Set;#t=0;constructor(e){this.#t=e}push(e){const t=this.#e;t.has(e)&&t.delete(e),t.add(e),t.size>this.#t&&this.#i()}resize(e,t=null){this.#t=e;const i=this.#e;if(t){const e=i.size;let s=1;for(const n of i)if(t.has(n.id)&&(i.delete(n),i.add(n)),++s>e)break}for(;i.size>this.#t;)this.#i()}has(e){return this.#e.has(e)}[Symbol.iterator](){return this.#e.keys()}#i(){const e=this.#e.keys().next().value;e?.destroy(),this.#e.delete(e)}}class B{#s=null;#n=e.NONE;#r=null;#o=i.ENABLE_FORMS;#a=null;#l=null;#h=!1;#c=!1;#d=null;#u=!1;#g=0;#p=new ResizeObserver(this.#f.bind(this));#_=null;#m=null;#P=null;#b=N.ENABLE;constructor(t){const s="undefined"!=typeof PDFJSDev?PDFJSDev.eval("BUNDLE_VERSION"):null;if(o!==s)throw new Error(`The API version "${o}" does not match the Viewer version "${s}".`);if(this.container=t.container,this.viewer=t.viewer||t.container.firstElementChild,"undefined"==typeof PDFJSDev||PDFJSDev.test("GENERIC")){if("DIV"!==this.container?.tagName||"DIV"!==this.viewer?.tagName)throw new Error("Invalid `container` and/or `viewer` option.");if(this.container.offsetParent&&"absolute"!==getComputedStyle(this.container).position)throw new Error("The `container` must be absolutely positioned.")}this.#p.observe(this.container),this.eventBus=t.eventBus,this.linkService=t.linkService||new V,this.downloadManager=t.downloadManager||null,this.findController=t.findController||null,this.findController&&(this.findController.onIsPageVisible=e=>this._getVisiblePages().ids.has(e)),this._scriptingManager=t.scriptingManager||null,this.#b=t.textLayerMode??N.ENABLE,this.#o=t.annotationMode??i.ENABLE_FORMS,this.#n=t.annotationEditorMode??e.NONE,this.imageResourcesPath=t.imageResourcesPath||"",this.enablePrintAutoRotate=t.enablePrintAutoRotate||!1,("undefined"==typeof PDFJSDev||PDFJSDev.test("GENERIC"))&&(this.removePageBorders=t.removePageBorders||!1),this.useOnlyCssZoom=t.useOnlyCssZoom||!1,this.isOffscreenCanvasSupported=t.isOffscreenCanvasSupported??!0,this.maxCanvasPixels=t.maxCanvasPixels,this.l10n=t.l10n||A,this.#h=t.enablePermissions||!1,this.pageColors=t.pageColors||null,this.defaultRenderingQueue=!t.renderingQueue,("undefined"==typeof PDFJSDev||PDFJSDev.test("GENERIC"))&&this.defaultRenderingQueue?(this.renderingQueue=new O,this.renderingQueue.setViewer(this)):this.renderingQueue=t.renderingQueue,this.scroll=I(this.container,this._scrollUpdate.bind(this)),this.presentationModeState=b.UNKNOWN,this._onBeforeDraw=this._onAfterDraw=null,this._resetView(),("undefined"==typeof PDFJSDev||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&this.viewer.classList.add("removePageBorders"),this.#v(),this.eventBus._on("thumbnailrendered",(({pageNumber:e,pdfPage:t})=>{const i=this._pages[e-1];this.#s.has(i)||t?.cleanup()}))}get pagesCount(){return this._pages.length}getPageView(e){return this._pages[e]}getCachedPageViews(){return new Set(this.#s)}get pageViewsReady(){return this._pagesCapability.settled&&this._pages.every((e=>e?.pdfPage))}get renderForms(){return this.#o===i.ENABLE_FORMS}get enableScripting(){return!!this._scriptingManager}get currentPageNumber(){return this._currentPageNumber}set currentPageNumber(e){if(!Number.isInteger(e))throw new Error("Invalid page number.");this.pdfDocument&&(this._setCurrentPageNumber(e,!0)||console.error(`currentPageNumber: "${e}" is not a valid page.`))}_setCurrentPageNumber(e,t=!1){if(this._currentPageNumber===e)return t&&this.#C(),!0;if(!(0<e&&e<=this.pagesCount))return!1;const i=this._currentPageNumber;return this._currentPageNumber=e,this.eventBus.dispatch("pagechanging",{source:this,pageNumber:e,pageLabel:this._pageLabels?.[e-1]??null,previous:i}),t&&this.#C(),!0}get currentPageLabel(){return this._pageLabels?.[this._currentPageNumber-1]??null}set currentPageLabel(e){if(!this.pdfDocument)return;let t=0|e;if(this._pageLabels){const i=this._pageLabels.indexOf(e);i>=0&&(t=i+1)}this._setCurrentPageNumber(t,!0)||console.error(`currentPageLabel: "${e}" is not a valid page.`)}get currentScale(){return this._currentScale!==y?this._currentScale:a}set currentScale(e){if(isNaN(e))throw new Error("Invalid numeric scale.");this.pdfDocument&&this.#E(e,{noScroll:!1})}get currentScaleValue(){return this._currentScaleValue}set currentScaleValue(e){this.pdfDocument&&this.#E(e,{noScroll:!1})}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!g(e))throw new Error("Invalid pages rotation angle.");if(!this.pdfDocument)return;if((e%=360)<0&&(e+=360),this._pagesRotation===e)return;this._pagesRotation=e;const t=this._currentPageNumber;this.refresh(!0,{rotation:e}),this._currentScaleValue&&this.#E(this._currentScaleValue,{noScroll:!0}),this.eventBus.dispatch("rotationchanging",{source:this,pagesRotation:e,pageNumber:t}),this.defaultRenderingQueue&&this.update()}get firstPagePromise(){return this.pdfDocument?this._firstPageCapability.promise:null}get onePageRendered(){return this.pdfDocument?this._onePageRenderedCapability.promise:null}get pagesPromise(){return this.pdfDocument?this._pagesCapability.promise:null}#S(){const e=this;return{get annotationEditorUIManager(){return e.#r},get annotationStorage(){return e.pdfDocument?.annotationStorage},get downloadManager(){return e.downloadManager},get enableScripting(){return!!e._scriptingManager},get fieldObjectsPromise(){return e.pdfDocument?.getFieldObjects()},get findController(){return e.findController},get hasJSActionsPromise(){return e.pdfDocument?.hasJSActions()},get linkService(){return e.linkService}}}#w(t){const n={annotationEditorMode:this.#n,annotationMode:this.#o,textLayerMode:this.#b};return t?(t.includes(s.COPY)||this.#b!==N.ENABLE||(n.textLayerMode=N.ENABLE_PERMISSIONS),t.includes(s.MODIFY_CONTENTS)||(n.annotationEditorMode=e.DISABLE),t.includes(s.MODIFY_ANNOTATIONS)||t.includes(s.FILL_INTERACTIVE_FORMS)||this.#o!==i.ENABLE_FORMS||(n.annotationMode=i.ENABLE),n):n}#M(){if("hidden"===document.visibilityState||!this.container.offsetParent||0===this._getVisiblePages().views.length)return Promise.resolve();const e=new Promise((e=>{this.#m=()=>{"hidden"===document.visibilityState&&(e(),document.removeEventListener("visibilitychange",this.#m),this.#m=null)},document.addEventListener("visibilitychange",this.#m)}));return Promise.race([this._onePageRenderedCapability.promise,e])}async getAllText(){const e=[],t=[];for(let i=1,s=this.pdfDocument.numPages;i<=s;++i){if(this.#u)return null;t.length=0;const s=await this.pdfDocument.getPage(i),{items:n}=await s.getTextContent();for(const e of n)e.str&&t.push(e.str),e.hasEOL&&t.push("\n");e.push(v(t.join("")))}return e.join("\n")}#N(e,t){const i=document.getSelection(),{focusNode:s,anchorNode:n}=i;if(n&&s&&i.containsNode(this.#d)){if(this.#c||e===N.ENABLE_PERMISSIONS)return t.preventDefault(),void t.stopPropagation();this.#c=!0;const i=this.container.style.cursor;this.container.style.cursor="wait";const s=e=>this.#u="Escape"===e.key;window.addEventListener("keydown",s),this.getAllText().then((async e=>{null!==e&&await navigator.clipboard.writeText(e)})).catch((e=>{console.warn(`Something goes wrong when extracting the text: ${e.message}`)})).finally((()=>{this.#c=!1,this.#u=!1,window.removeEventListener("keydown",s),this.container.style.cursor=i})),t.preventDefault(),t.stopPropagation()}}setDocument(i){if(this.pdfDocument&&(this.eventBus.dispatch("pagesdestroy",{source:this}),this._cancelRendering(),this._resetView(),this.findController?.setDocument(null),this._scriptingManager?.setDocument(null),this.#r&&(this.#r.destroy(),this.#r=null)),this.pdfDocument=i,!i)return;const s=i.numPages,r=i.getPage(1),o=i.getOptionalContentConfig(),a=this.#h?i.getPermissions():Promise.resolve();if(s>R.FORCE_SCROLL_MODE_PAGE){console.warn("Forcing PAGE-scrolling for performance reasons, given the length of the document.");const e=this._scrollMode=w.PAGE;this.eventBus.dispatch("scrollmodechanged",{source:this,mode:e})}this._pagesCapability.promise.then((()=>{this.eventBus.dispatch("pagesloaded",{source:this,pagesCount:s})}),(()=>{})),this._onBeforeDraw=e=>{const t=this._pages[e.pageNumber-1];t&&this.#s.push(t)},this.eventBus._on("pagerender",this._onBeforeDraw),this._onAfterDraw=e=>{e.cssTransform||this._onePageRenderedCapability.settled||(this._onePageRenderedCapability.resolve({timestamp:e.timestamp}),this.eventBus._off("pagerendered",this._onAfterDraw),this._onAfterDraw=null,this.#m&&(document.removeEventListener("visibilitychange",this.#m),this.#m=null))},this.eventBus._on("pagerendered",this._onAfterDraw),Promise.all([r,a]).then((([r,a])=>{if(i!==this.pdfDocument)return;this._firstPageCapability.resolve(r),this._optionalContentConfigPromise=o;const{annotationEditorMode:l,annotationMode:h,textLayerMode:c}=this.#w(a);if(c!==N.DISABLE){const e=this.#d=document.createElement("div");e.id="hiddenCopyElement",this.viewer.before(e)}if(l!==e.DISABLE){const s=l;i.isPureXfa?console.warn("Warning: XFA-editing is not implemented."):F(s)?(this.#r=new t(this.container,this.eventBus,i,this.pageColors),s!==e.NONE&&this.#r.updateMode(s)):console.error(`Invalid AnnotationEditor mode: ${s}`)}const d=this.#S.bind(this),u=this._scrollMode===w.PAGE?null:this.viewer,g=this.currentScale,p=r.getViewport({scale:g*n.PDF_TO_CSS_UNITS});this.viewer.style.setProperty("--scale-factor",p.scale),"CanvasText"!==this.pageColors?.foreground&&"Canvas"!==this.pageColors?.background||this.viewer.style.setProperty("--hcm-highligh-filter",i.filterFactory.addHighlightHCMFilter("CanvasText","Canvas","HighlightText","Highlight"));for(let e=1;e<=s;++e){const t=new L({container:u,eventBus:this.eventBus,id:e,scale:g,defaultViewport:p.clone(),optionalContentConfigPromise:o,renderingQueue:this.renderingQueue,textLayerMode:c,annotationMode:h,imageResourcesPath:this.imageResourcesPath,useOnlyCssZoom:this.useOnlyCssZoom,isOffscreenCanvasSupported:this.isOffscreenCanvasSupported,maxCanvasPixels:this.maxCanvasPixels,pageColors:this.pageColors,l10n:this.l10n,layerProperties:d});this._pages.push(t)}const f=this._pages[0];f&&(f.setPdfPage(r),this.linkService.cachePageRef(1,r.ref)),this._scrollMode===w.PAGE?this.#y():this._spreadMode!==M.NONE&&this._updateSpreadMode(),this.#M().then((async()=>{if(this.findController?.setDocument(i),this._scriptingManager?.setDocument(i),this.#d&&(this.#l=this.#N.bind(this,c),document.addEventListener("copy",this.#l)),this.#r&&this.eventBus.dispatch("annotationeditormodechanged",{source:this,mode:this.#n}),i.loadingParams.disableAutoFetch||s>R.FORCE_LAZY_PAGE_INIT)return void this._pagesCapability.resolve();let e=s-1;if(e<=0)this._pagesCapability.resolve();else for(let t=2;t<=s;++t){const s=i.getPage(t).then((i=>{const s=this._pages[t-1];s.pdfPage||s.setPdfPage(i),this.linkService.cachePageRef(t,i.ref),0==--e&&this._pagesCapability.resolve()}),(i=>{console.error(`Unable to get page ${t} to initialize viewer`,i),0==--e&&this._pagesCapability.resolve()}));t%R.PAUSE_EAGER_PAGE_INIT==0&&await s}})),this.eventBus.dispatch("pagesinit",{source:this}),i.getMetadata().then((({info:e})=>{i===this.pdfDocument&&e.Language&&(this.viewer.lang=e.Language)})),this.defaultRenderingQueue&&this.update()})).catch((e=>{console.error("Unable to initialize viewer",e),this._pagesCapability.reject(e)}))}setPageLabels(e){if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let e=0,t=this._pages.length;e<t;e++)this._pages[e].setPageLabel(this._pageLabels?.[e]??null)}}_resetView(){this._pages=[],this._currentPageNumber=1,this._currentScale=y,this._currentScaleValue=null,this._pageLabels=null,this.#s=new T(10),this._location=null,this._pagesRotation=0,this._optionalContentConfigPromise=null,this._firstPageCapability=new r,this._onePageRenderedCapability=new r,this._pagesCapability=new r,this._scrollMode=w.VERTICAL,this._previousScrollMode=w.UNKNOWN,this._spreadMode=M.NONE,this.#_={previousPageNumber:1,scrollDown:!0,pages:[]},this._onBeforeDraw&&(this.eventBus._off("pagerender",this._onBeforeDraw),this._onBeforeDraw=null),this._onAfterDraw&&(this.eventBus._off("pagerendered",this._onAfterDraw),this._onAfterDraw=null),this.#m&&(document.removeEventListener("visibilitychange",this.#m),this.#m=null),this.viewer.textContent="",this._updateScrollMode(),this.viewer.removeAttribute("lang"),this.#d&&(document.removeEventListener("copy",this.#l),this.#l=null,this.#d.remove(),this.#d=null)}#y(){if(this._scrollMode!==w.PAGE)throw new Error("#ensurePageViewVisible: Invalid scrollMode value.");const e=this._currentPageNumber,t=this.#_,i=this.viewer;if(i.textContent="",t.pages.length=0,this._spreadMode!==M.NONE||this.isInPresentationMode){const s=new Set,n=this._spreadMode-1;-1===n?s.add(e-1):e%2!==n?(s.add(e-1),s.add(e)):(s.add(e-2),s.add(e-1));const r=document.createElement("div");if(r.className="spread",this.isInPresentationMode){const e=document.createElement("div");e.className="dummyPage",r.append(e)}for(const e of s){const i=this._pages[e];i&&(r.append(i.div),t.pages.push(i))}i.append(r)}else{const s=this._pages[e-1];i.append(s.div),t.pages.push(s)}t.scrollDown=e>=t.previousPageNumber,t.previousPageNumber=e}_scrollUpdate(){0!==this.pagesCount&&this.update()}#D(e,t=null){const{div:i,id:s}=e;if(this._currentPageNumber!==s&&this._setCurrentPageNumber(s),this._scrollMode===w.PAGE&&(this.#y(),this.update()),!t&&!this.isInPresentationMode){const e=i.offsetLeft+i.clientLeft,s=e+i.clientWidth,{scrollLeft:n,clientWidth:r}=this.container;(this._scrollMode===w.HORIZONTAL||e<n||s>n+r)&&(t={left:0,top:0})}S(i,t),!this._currentScaleValue&&this._location&&(this._location=null)}#I(e){return e===this._currentScale||Math.abs(e-this._currentScale)<1e-15}#A(e,t,{noScroll:i=!1,preset:s=!1,drawingDelay:r=-1}){if(this._currentScaleValue=t.toString(),this.#I(e))return void(s&&this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:t}));this.viewer.style.setProperty("--scale-factor",e*n.PDF_TO_CSS_UNITS);const o=r>=0&&r<1e3;if(this.refresh(!0,{scale:e,drawingDelay:o?r:-1}),o&&(this.#P=setTimeout((()=>{this.#P=null,this.refresh()}),r)),this._currentScale=e,!i){let e,t=this._currentPageNumber;!this._location||this.isInPresentationMode||this.isChangingPresentationMode||(t=this._location.pageNumber,e=[null,{name:"XYZ"},this._location.left,this._location.top,null]),this.scrollPageIntoView({pageNumber:t,destArray:e,allowNegativeOffset:!0})}this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:s?t:void 0}),this.defaultRenderingQueue&&this.update()}get#L(){return this._spreadMode!==M.NONE&&this._scrollMode!==w.HORIZONTAL?2:1}#E(e,t){let i=parseFloat(e);if(i>0)t.preset=!1,this.#A(i,e,t);else{const s=this._pages[this._currentPageNumber-1];if(!s)return;let n=E,r=D;this.isInPresentationMode?(n=r=4,this._spreadMode!==M.NONE&&(n*=2)):("undefined"==typeof PDFJSDev||PDFJSDev.test("GENERIC"))&&this.removePageBorders?n=r=0:this._scrollMode===w.HORIZONTAL&&([n,r]=[r,n]);const o=(this.container.clientWidth-n)/s.width*s.scale/this.#L,a=(this.container.clientHeight-r)/s.height*s.scale;switch(e){case"page-actual":i=1;break;case"page-width":i=o;break;case"page-height":i=a;break;case"page-fit":i=Math.min(o,a);break;case"auto":const t=u(s)?o:Math.min(a,o);i=Math.min(_,t);break;default:return void console.error(`#setScale: "${e}" is an unknown zoom value.`)}t.preset=!0,this.#A(i,e,t)}}#C(){const e=this._pages[this._currentPageNumber-1];this.isInPresentationMode&&this.#E(this._currentScaleValue,{noScroll:!0}),this.#D(e)}pageLabelToPageNumber(e){if(!this._pageLabels)return null;const t=this._pageLabels.indexOf(e);return t<0?null:t+1}scrollPageIntoView({pageNumber:e,destArray:t=null,allowNegativeOffset:i=!1,ignoreDestinationZoom:s=!1}){if(!this.pdfDocument)return;const r=Number.isInteger(e)&&this._pages[e-1];if(!r)return void console.error(`scrollPageIntoView: "${e}" is not a valid pageNumber parameter.`);if(this.isInPresentationMode||!t)return void this._setCurrentPageNumber(e,!0);let o,a,l=0,c=0,d=0,u=0;const g=r.rotation%180!=0,p=(g?r.height:r.width)/r.scale/n.PDF_TO_CSS_UNITS,f=(g?r.width:r.height)/r.scale/n.PDF_TO_CSS_UNITS;let _=0;switch(t[1].name){case"XYZ":l=t[2],c=t[3],_=t[4],l=null!==l?l:0,c=null!==c?c:f;break;case"Fit":case"FitB":_="page-fit";break;case"FitH":case"FitBH":c=t[2],_="page-width",null===c&&this._location?(l=this._location.left,c=this._location.top):("number"!=typeof c||c<0)&&(c=f);break;case"FitV":case"FitBV":l=t[2],d=p,u=f,_="page-height";break;case"FitR":l=t[2],c=t[3],d=t[4]-l,u=t[5]-c;let e=E,i=D;("undefined"==typeof PDFJSDev||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&(e=i=0),o=(this.container.clientWidth-e)/d/n.PDF_TO_CSS_UNITS,a=(this.container.clientHeight-i)/u/n.PDF_TO_CSS_UNITS,_=Math.min(Math.abs(o),Math.abs(a));break;default:return void console.error(`scrollPageIntoView: "${t[1].name}" is not a valid destination type.`)}if(s||(_&&_!==this._currentScale?this.currentScaleValue=_:this._currentScale===y&&(this.currentScaleValue=h)),"page-fit"===_&&!t[4])return void this.#D(r);const m=[r.viewport.convertToViewportPoint(l,c),r.viewport.convertToViewportPoint(l+d,c+u)];let P=Math.min(m[0][0],m[1][0]),b=Math.min(m[0][1],m[1][1]);i||(P=Math.max(P,0),b=Math.max(b,0)),this.#D(r,{left:P,top:b})}_updateLocation(e){const t=this._currentScale,i=this._currentScaleValue,s=parseFloat(i)===t?Math.round(1e4*t)/100:i,n=e.id,r=this._pages[n-1],o=this.container,a=r.getPagePoint(o.scrollLeft-e.x,o.scrollTop-e.y),l=Math.round(a[0]),h=Math.round(a[1]);let c=`#page=${n}`;this.isInPresentationMode||(c+=`&zoom=${s},${l},${h}`),this._location={pageNumber:n,scale:s,top:h,left:l,rotation:this._pagesRotation,pdfOpenParams:c}}update(){const e=this._getVisiblePages(),t=e.views,i=t.length;if(0===i)return;const s=Math.max(10,2*i+1);this.#s.resize(s,e.ids),this.renderingQueue.renderHighestPriority(e);const n=this._spreadMode===M.NONE&&(this._scrollMode===w.PAGE||this._scrollMode===w.VERTICAL),r=this._currentPageNumber;let o=!1;for(const e of t){if(e.percent<100)break;if(e.id===r&&n){o=!0;break}}this._setCurrentPageNumber(o?r:t[0].id),this._updateLocation(e.first),this.eventBus.dispatch("updateviewarea",{source:this,location:this._location})}containsElement(e){return this.container.contains(e)}focus(){this.container.focus()}get _isContainerRtl(){return"rtl"===getComputedStyle(this.container).direction}get isInPresentationMode(){return this.presentationModeState===b.FULLSCREEN}get isChangingPresentationMode(){return this.presentationModeState===b.CHANGING}get isHorizontalScrollbarEnabled(){return!this.isInPresentationMode&&this.container.scrollWidth>this.container.clientWidth}get isVerticalScrollbarEnabled(){return!this.isInPresentationMode&&this.container.scrollHeight>this.container.clientHeight}_getVisiblePages(){const e=this._scrollMode===w.PAGE?this.#_.pages:this._pages,t=this._scrollMode===w.HORIZONTAL,i=t&&this._isContainerRtl;return d({scrollEl:this.container,views:e,sortByVisibility:!0,horizontal:t,rtl:i})}cleanup(){for(const e of this._pages)e.renderingState!==C.FINISHED&&e.reset()}_cancelRendering(){for(const e of this._pages)e.cancelRendering()}async#O(e){if(e.pdfPage)return e.pdfPage;try{const t=await this.pdfDocument.getPage(e.id);return e.pdfPage||e.setPdfPage(t),this.linkService._cachedPageNumber?.(t.ref)||this.linkService.cachePageRef(e.id,t.ref),t}catch(e){return console.error("Unable to get page for page view",e),null}}#V(e){if(1===e.first?.id)return!0;if(e.last?.id===this.pagesCount)return!1;switch(this._scrollMode){case w.PAGE:return this.#_.scrollDown;case w.HORIZONTAL:return this.scroll.right}return this.scroll.down}forceRendering(e){const t=e||this._getVisiblePages(),i=this.#V(t),s=this._spreadMode!==M.NONE&&this._scrollMode!==w.HORIZONTAL,n=this.renderingQueue.getHighestPriority(t,this._pages,i,s);return!!n&&(this.#O(n).then((()=>{this.renderingQueue.renderView(n)})),!0)}get hasEqualPageSizes(){const e=this._pages[0];for(let t=1,i=this._pages.length;t<i;++t){const i=this._pages[t];if(i.width!==e.width||i.height!==e.height)return!1}return!0}getPagesOverview(){let e;return this._pages.map((t=>{const i=t.pdfPage.getViewport({scale:1}),s=u(i);if(void 0===e)e=s;else if(this.enablePrintAutoRotate&&s!==e)return{width:i.height,height:i.width,rotation:(i.rotation-90)%360};return{width:i.width,height:i.height,rotation:i.rotation}}))}get optionalContentConfigPromise(){return this.pdfDocument?this._optionalContentConfigPromise?this._optionalContentConfigPromise:(console.error("optionalContentConfigPromise: Not initialized yet."),this.pdfDocument.getOptionalContentConfig()):Promise.resolve(null)}set optionalContentConfigPromise(e){if(!(e instanceof Promise))throw new Error(`Invalid optionalContentConfigPromise: ${e}`);this.pdfDocument&&this._optionalContentConfigPromise&&(this._optionalContentConfigPromise=e,this.refresh(!1,{optionalContentConfigPromise:e}),this.eventBus.dispatch("optionalcontentconfigchanged",{source:this,promise:e}))}get scrollMode(){return this._scrollMode}set scrollMode(e){if(!("undefined"==typeof PDFJSDev?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))&&this._scrollMode!==e){if(!p(e))throw new Error(`Invalid scroll mode: ${e}`);this.pagesCount>R.FORCE_SCROLL_MODE_PAGE||(this._previousScrollMode=this._scrollMode,this._scrollMode=e,this.eventBus.dispatch("scrollmodechanged",{source:this,mode:e}),this._updateScrollMode(this._currentPageNumber))}}_updateScrollMode(e=null){const t=this._scrollMode,i=this.viewer;i.classList.toggle("scrollHorizontal",t===w.HORIZONTAL),i.classList.toggle("scrollWrapped",t===w.WRAPPED),this.pdfDocument&&e&&(t===w.PAGE?this.#y():this._previousScrollMode===w.PAGE&&this._updateSpreadMode(),this._currentScaleValue&&isNaN(this._currentScaleValue)&&this.#E(this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}get spreadMode(){return this._spreadMode}set spreadMode(e){if(!("undefined"==typeof PDFJSDev?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))&&this._spreadMode!==e){if(!f(e))throw new Error(`Invalid spread mode: ${e}`);this._spreadMode=e,this.eventBus.dispatch("spreadmodechanged",{source:this,mode:e}),this._updateSpreadMode(this._currentPageNumber)}}_updateSpreadMode(e=null){if(!this.pdfDocument)return;const t=this.viewer,i=this._pages;if(this._scrollMode===w.PAGE)this.#y();else if(t.textContent="",this._spreadMode===M.NONE)for(const e of this._pages)t.append(e.div);else{const e=this._spreadMode-1;let s=null;for(let n=0,r=i.length;n<r;++n)null===s?(s=document.createElement("div"),s.className="spread",t.append(s)):n%2===e&&(s=s.cloneNode(!1),t.append(s)),s.append(i[n].div)}e&&(this._currentScaleValue&&isNaN(this._currentScaleValue)&&this.#E(this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}_getPageAdvance(e,t=!1){switch(this._scrollMode){case w.WRAPPED:{const{views:i}=this._getVisiblePages(),s=new Map;for(const{id:e,y:t,percent:n,widthPercent:r}of i){if(0===n||r<100)continue;let i=s.get(t);i||s.set(t,i||=[]),i.push(e)}for(const i of s.values()){const s=i.indexOf(e);if(-1===s)continue;const n=i.length;if(1===n)break;if(t)for(let t=s-1,n=0;t>=n;t--){const s=i[t],n=i[t+1]-1;if(s<n)return e-n}else for(let t=s+1,r=n;t<r;t++){const s=i[t],n=i[t-1]+1;if(s>n)return n-e}if(t){const t=i[0];if(t<e)return e-t+1}else{const t=i[n-1];if(t>e)return t-e+1}break}break}case w.HORIZONTAL:break;case w.PAGE:case w.VERTICAL:{if(this._spreadMode===M.NONE)break;const i=this._spreadMode-1;if(t&&e%2!==i)break;if(!t&&e%2===i)break;const{views:s}=this._getVisiblePages(),n=t?e-1:e+1;for(const{id:e,percent:t,widthPercent:i}of s)if(e===n){if(t>0&&100===i)return 2;break}break}}return 1}nextPage(){const e=this._currentPageNumber,t=this.pagesCount;if(e>=t)return!1;const i=this._getPageAdvance(e,!1)||1;return this.currentPageNumber=Math.min(e+i,t),!0}previousPage(){const e=this._currentPageNumber;if(e<=1)return!1;const t=this._getPageAdvance(e,!0)||1;return this.currentPageNumber=Math.max(e-t,1),!0}increaseScale({drawingDelay:e,scaleFactor:t,steps:i}={}){if(!this.pdfDocument)return;let s=this._currentScale;if(t>1)s=Math.round(s*t*100)/100;else{i??=1;do{s=Math.ceil(10*(s*l).toFixed(2))/10}while(--i>0&&s<m)}this.#E(Math.min(m,s),{noScroll:!1,drawingDelay:e})}decreaseScale({drawingDelay:e,scaleFactor:t,steps:i}={}){if(!this.pdfDocument)return;let s=this._currentScale;if(t>0&&t<1)s=Math.round(s*t*100)/100;else{i??=1;do{s=Math.floor(10*(s/l).toFixed(2))/10}while(--i>0&&s>P)}this.#E(Math.max(P,s),{noScroll:!1,drawingDelay:e})}#v(e=this.container.clientHeight){e!==this.#g&&(this.#g=e,c.setProperty("--viewer-container-height",`${e}px`))}#f(e){for(const t of e)if(t.target===this.container){this.#v(Math.floor(t.borderBoxSize[0].blockSize)),this.#a=null;break}}get containerTopLeft(){return this.#a||=[this.container.offsetTop,this.container.offsetLeft]}get annotationEditorMode(){return this.#r?this.#n:e.DISABLE}set annotationEditorMode({mode:e,editId:t=null}){if(!this.#r)throw new Error("The AnnotationEditor is not enabled.");if(this.#n!==e){if(!F(e))throw new Error(`Invalid AnnotationEditor mode: ${e}`);this.pdfDocument&&(this.#n=e,this.eventBus.dispatch("annotationeditormodechanged",{source:this,mode:e}),this.#r.updateMode(e,t))}}set annotationEditorParams({type:e,value:t}){if(!this.#r)throw new Error("The AnnotationEditor is not enabled.");this.#r.updateParams(e,t)}refresh(e=!1,t=Object.create(null)){if(this.pdfDocument){for(const e of this._pages)e.update(t);null!==this.#P&&(clearTimeout(this.#P),this.#P=null),e||this.update()}}}export{R as PagesCountLimit,T as PDFPageViewBuffer,B as PDFViewer};