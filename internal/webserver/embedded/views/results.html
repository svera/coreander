{{$lang := .Lang}}
{{$emailSendingConfigured := .EmailSendingConfigured}}
{{$session := .Session}}
{{$emailFrom := .EmailFrom}}
<div class="container">
    {{template "partials/searchbox" .}} {{if gt .Total 0}}
    <p>{{t .Lang "%d matches found" .Total }}</p>
    {{else}}
    <p>{{t .Lang "No matches found" }}</p>
    {{end}}

    <div class="list-group">
        {{if .Results}} {{range $i, $book := .Results}}
        <div class="list-group-item">
            <img src="covers/{{$book.ID}}" class="border border-2 border-dark float-start me-3 2-25">
            <div class="row">
                <div class="col-7">
                    {{ if ne $book.Series "" }} {{$seriesTitle := t $lang "Search for more titles belonging to %s"
                    $book.Series}}
                    <p class="text-start text-muted text-uppercase mb-0"><a
                            href="?search=Series&colon;&quot;{{$book.Series}}&quot;"
                            title={{$seriesTitle}}>{{$book.Series}} {{$book.SeriesIndex}}</a></p>
                    {{ end }}
                    <h4 class="text-start">{{$book.Title}} <small class="small text-muted">{{$book.Year}}</small>
                    </h4>
                </div>
                <div class="col-5 text-end">
                    {{ template "partials/actions" dict "Lang" $lang "Book" $book "EmailSendingConfigured"
                    $emailSendingConfigured "Index" $i "Session" $session "EmailFrom" $emailFrom}}
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    {{if $book.Author}}
                    {{$authorTitle := t $lang "Search for more titles by %s" $book.Author}}
                    <h5 class="text-start"><a href="?search=Author&colon;&quot;{{$book.Author}}&quot;"
                            title={{$authorTitle}}>{{$book.Author}}</a></h5>
                    {{else}}
                        <h5 class="text-start">{{t $lang "Unknown author"}}</h5>
                    {{end}}

                    {{ if ne $book.ReadingTime "" }}
                    <p class="text-start text-muted"><em>{{t $lang "Estimated reading time"}}:
                            {{$book.ReadingTime}}</em></p>
                    {{ end }}

                    {{ if $book.Pages }}
                    <p class="text-start text-muted"><em>{{t $lang "%d pages" $book.Pages}}</em></p>
                    {{ end }}

                    {{if $book.Description}}
                    <div class="mb-1 collapse" id="collapse-desc{{$i}}">{{$book.Description}}</div>
                    {{else}}
                    <div class="mb-1"><em>{{t $lang "No description available"}}</em></div>
                    {{end}}

                    <a data-bs-toggle="collapse" class="collapse-control collapsed" href="#collapse-desc{{$i}}"></a>
                </div>
            </div>
        </div>
        {{end}} {{end}}
    </div>

    {{ $length := len .Paginator.Pages }} {{ if gt $length 1 }}
    {{template "partials/pagination" .}}
    {{end}}

</div>

<script type="text/javascript">
    function send(index) {
        event.preventDefault();
        form = document.getElementById("send-email-" + index)
        fetch('/send', {
            method: "POST",
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'email': form.elements[0].value,
                'file': form.elements[1].value,        
            })
        })
        .then((response) => {
            message = document.getElementById("send-email-message-" + index)
            message.classList.remove("visually-hidden");
            if (!response.ok) {
                message.innerHTML = '{{t .Lang "There was an error sending the document, please try again later"}}';
                message.classList.add("text-danger");
            } else {
                message.innerHTML = '{{t .Lang "Document sent succesfully"}}';
                message.classList.add("text-success");
            }
        })
        .catch(function (error) {
            // Catch errors
            console.log(error);
        });
    }
</script>
