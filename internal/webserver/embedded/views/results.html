{{$lang := .Lang}}
{{$emailSendingConfigured := .EmailSendingConfigured}}
{{$session := .Session}}
{{$emailFrom := .EmailFrom}}
{{$wordsPerMinute := .WordsPerMinute}}

<div class="container">
    {{template "partials/searchbox" .}} {{if gt .Total 0}}
    <p>{{t .Lang "%d matches found" .Total }}</p>
    {{else}}
    <p>{{t .Lang "No matches found" }}</p>
    {{end}}

    <div class="list-group list-group-flush">
        {{if .Results}} {{range $i, $book := .Results}}
        <div class="list-group-item">
            <div class="row">
                <div class="col-md-2 col-sm-12">
                    <img src="/images/generic.jpg" data-src="cover/{{$book.Slug}}" loading="lazy" class="border border-2 border-dark text-center mb-3 cover img-fluid" alt='{{t $lang "\"%s\" cover" $book.Title}}'>
                </div>
                <div class="col-md-10 col-sm-12">
                    <div class="row">
                        <div class="col-7">
                            {{ if ne $book.Series "" }} {{$seriesTitle := t $lang "Search for more titles belonging to %s"
                            $book.Series}}
                            <p class="text-start text-muted text-uppercase mb-0"><a
                                    href="/{{$lang}}?search=Series&colon;&quot;{{$book.Series}}&quot;"
                                    title={{$seriesTitle}}>{{$book.Series}} {{$book.SeriesIndex}}</a></p>
                            {{ end }}
                            <h4 class="text-start">
                                <a href="/{{$lang}}/document/{{$book.Slug}}">{{$book.Title}}</a> <small class="small text-muted">{{$book.Year}}</small>
                            </h4>
                        </div>
                        <div class="col-5 text-end">
                            {{ template "partials/actions" dict "Lang" $lang "Book" $book "EmailSendingConfigured"
                            $emailSendingConfigured "Index" $i "Session" $session "EmailFrom" $emailFrom}}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-start">
                            {{if $book.Authors}}
                            <h5>
                                {{range $i, $author := $book.Authors}}
                                {{$authorTitle := t $lang "Search for more titles by %s" $author}}
                                <a href="/{{$lang}}?search=Authors&colon;&quot;{{$author}}&quot;" title={{$authorTitle}}>{{$author}}</a>{{if notLast $book.Authors $i}}, {{end}}
                                {{end}}
                            </h5>
                            {{else}}
                                <h5>{{t $lang "Unknown author"}}</h5>
                            {{end}}
        
                            {{ if gt $book.Words 0.0 }}
                            <p class="text-muted"><em>{{t $lang "Estimated reading time"}}:
                                    {{$book.ReadingTime $wordsPerMinute}}</em></p>
                            {{ end }}
        
                            {{ if $book.Pages }}
                            <p class="text-muted"><em>{{t $lang "%d pages" $book.Pages}}</em></p>
                            {{ end }}
        
                            {{ if $book.Subjects }}
                            <div class="mb-3">
                                {{range $i, $subject := $book.Subjects}}
                                    {{$subjectTitle := t $lang "Search for more titles in %s" $subject}}
                                    <a class="btn btn-secondary btn-sm" href="/{{$lang}}?search=Subjects&colon;&quot;{{$subject}}&quot;" title={{$subjectTitle}}>{{$subject}}</a>
                                {{end}}
                            </div>
                            {{ end }}

                            {{if $book.Description}}
                            <div class="mb-1 collapse" id="collapse-desc{{$i}}">{{$book.Description}}</div>
                            {{else}}
                            <div class="mb-1"><em>{{t $lang "No description available"}}</em></div>
                            {{end}}
        
                            <a data-bs-toggle="collapse" class="collapse-control collapsed" href="#collapse-desc{{$i}}"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{end}} {{end}}
    </div>

    {{ $length := len .Paginator.Pages }} {{ if gt $length 1 }}
    {{template "partials/pagination" .}}
    {{end}}

</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/delete" onsubmit="remove()" id="delete-form">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="deleteModalLabel">{{t .Lang "Delete document"}}</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger visually-hidden" role="alert" id="delete-document-message">
                    </div>
                    <p>{{ t .Lang "Are you sure you want to delete this document?"}}</p>
                    <p>{{ t .Lang "This action cannot be undone"}}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{t .Lang
                        "Cancel"}}</button>
                    <button type="submit" class="btn btn-primary">{{t .Lang "Delete"}}</button>
                </div>
                <input type="hidden" name="slug" value="" class="slug">
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    const deleteModal = document.getElementById('deleteModal')
    deleteModal.addEventListener('show.bs.modal', event => {
        const link = event.relatedTarget
        const slug = link.getAttribute('data-bs-slug')
        const modalInputSlug = deleteModal.querySelector('.slug')

        modalInputSlug.value = slug;
    })

    function send(index) {
        event.preventDefault();
        let formID = "send-email-" + index;
        let submit = document.querySelector('#'+formID+' button');
        let envelope = document.querySelector('#envelope-'+index);
        let spinner = document.querySelector('#spinner-'+index);
        form = document.getElementById(formID);
        submit.setAttribute("disabled", true);
        spinner.classList.remove("visually-hidden");
        envelope.classList.add("visually-hidden");
        fetch('/send', {
            method: "POST",
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'email': form.elements[0].value,
                'slug': form.elements[1].value,        
            })
        })
        .then((response) => {
            message = document.getElementById("send-email-message-" + index)
            message.classList.remove("visually-hidden");
            if (!response.ok) {
                message.innerHTML = '{{t .Lang "There was an error sending the document, please try again later"}}';
                message.classList.add("text-danger");
            } else {
                message.innerHTML = '{{t .Lang "Document sent succesfully"}}';
                message.classList.add("text-success");
            }
            submit.removeAttribute("disabled");
            envelope.classList.remove("visually-hidden");
            spinner.classList.add("visually-hidden");
        })
        .catch(function (error) {
            // Catch errors
            console.log(error);
        });
    }

    function remove() {
        event.preventDefault();
        form = document.getElementById("delete-form");
        fetch('/delete', {
            method: "POST",
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'slug': form.elements['slug'].value,        
            })
        })
        .then((response) => {
            if (response.ok) {
                location.reload();
            }
            message = document.getElementById("delete-document-message")
            message.classList.remove("visually-hidden");
            message.innerHTML = '{{t .Lang "There was an error deleting the document"}}';
        })
        .catch(function (error) {
            // Catch errors
            console.log(error);
        });
    }

    window.onload = function() {
        let imgs = document.querySelectorAll('.cover');
        for (i = 0; i < imgs.length; i++) {
            if (imgs[i].getAttribute('data-src')) {
                imgs[i].addEventListener('error', function onError(e) {
                    this.setAttribute('src', '/images/generic.jpg');
                });
                imgs[i].setAttribute('src', imgs[i].getAttribute('data-src'));
            }
        }
    }
</script>
