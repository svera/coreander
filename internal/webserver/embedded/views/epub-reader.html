<!doctype html>
<html lang="{{.Lang}}" class="h-100">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Sergio Vera">
    <title>{{t .Lang .Title}}</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- Favicons -->
    <script src="/js/jszip.min.js"></script>
    <script src="/js/epub.min.js"></script>

    <meta name="theme-color" content="#000">
</head>

<body class="text-center d-flex flex-column h-100">
    <header>
        <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
            <div class="container justify-content-center">
                <div class="row">
                    <div class="col">
                        <a id="prev" href="#prev" class="navlink btn btn-dark text-truncate">«</a>
                    </div>
                    <div class="col-8">
                        <select class="form-select" id="toc"></select>
                    </div>
                    <div class="col">
                        <a id="next" href="#next" class="navlink btn btn-dark text-truncate">»</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div id="viewer" class="scrolled mt-5"></div>

    <script>
        var params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
        var url = params && params.get("url") && decodeURIComponent(params.get("url"));
        var currentSectionIndex = (params && params.get("loc")) ? params.get("loc") : undefined;

        var book = ePub("/files/{{.Filename}}");
        var rendition = book.renderTo("viewer", {
            flow: "scrolled-doc"
        });

        rendition.display(currentSectionIndex);

        var next = document.getElementById("next");
        next.addEventListener("click", function (e) {
            rendition.next();
            e.preventDefault();
        }, false);

        var prev = document.getElementById("prev");
        prev.addEventListener("click", function (e) {
            rendition.prev();
            e.preventDefault();
        }, false);

        rendition.on("relocated", function (location) {
            window.location.hash = "#prev";
            var $select = document.getElementById("toc");
            for (i = 0; i < $select.options.length; i++) {
                    if ($select.options[i].ref == location.start.href) {
                        $select.selectedIndex = i;
                        return;
                    }
                }
        });

        rendition.on("rendered", function (section) {
            var nextSection = section.next();
            var prevSection = section.prev();
            var $select = document.getElementById("toc");

            if (nextSection) {
                next.className = "btn btn-dark";
            } else {
                next.className = "btn btn-dark disabled";
            }

            if (prevSection) {
                prev.className = "btn btn-dark";
            } else {
                prev.className = "btn btn-dark disabled";
            }

            book.loaded.navigation.then(function (toc) {
                var $select = document.getElementById("toc"),
                    docfrag = document.createDocumentFragment();

                if ($select.options.length > 0) {
                    return;
                }

                toc.forEach(function (chapter) {
                    var option = document.createElement("option");
                    option.textContent = chapter.label;
                    option.ref = chapter.href;

                    docfrag.appendChild(option);
                });

                $select.appendChild(docfrag);

                $select.onchange = function () {
                    var index = $select.selectedIndex,
                        url = $select.options[index].ref;
                    rendition.display(url);
                    return false;
                };

            });
        });
    </script>
</body>

</html>